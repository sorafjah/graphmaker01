<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>グラフメーカー</title>
    <!-- Tailwind CSS (スタイリング用) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts (BIZ UDGothic) -->
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDGothic:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'BIZ UDGothic', sans-serif;
        }
        /* 印刷時の設定 */
        @media print {
            @page { margin: 12mm; }
            body { background: white; color: black; }
            .no-print { display: none !important; }
            .print-block { display: block !important; }
            .print-w-full { width: 100% !important; }
            .print-w-1-3 { width: 33.333333% !important; }
            .print-w-2-3 { width: 66.666667% !important; }
            .print-flex-row { flex-direction: row !important; }
            .print-shadow-none { box-shadow: none !important; }
            .print-bg-gray-200 { background-color: #e5e7eb !important; -webkit-print-color-adjust: exact; }
            .print-bg-gray-100 { background-color: #f3f4f6 !important; -webkit-print-color-adjust: exact; }
            .print-bg-gray-50 { background-color: #f9fafb !important; -webkit-print-color-adjust: exact; }
            .print-border-gray-800 { border-color: #1f2937 !important; }
            
            /* 印刷時の入力フィールド調整 */
            input.question-input {
                border: none !important;
                background: transparent !important;
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">

    <div id="app">
        <!-- ここにJavaScriptでコンテンツが描画されます -->
    </div>

    <script>
        // --- アイコン (SVG文字列) ---
        const Icons = {
            settings: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>`,
            fileText: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`,
            checkSquare: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>`,
            refresh: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>`,
            printer: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>`,
            arrowLeft: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>`,
            eye: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`,
            eyeOff: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>`,
            plus: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
            minus: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
            edit: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`
        };

        // --- データ定義 ---
        const THEMES = {
            lunch: {
                label: '好きなメニュー',
                unit: '人',
                items: [
                    { name: 'カレー' }, { name: '唐揚げ' }, { name: 'ハンバーグ' },
                    { name: 'ラーメン' }, { name: 'パスタ' }, { name: '焼き魚' },
                    { name: 'うどん' }, { name: 'オムライス' },
                ]
            },
            sports: {
                label: '好きなスポーツ',
                unit: '人',
                items: [
                    { name: 'サッカー' }, { name: '野球' }, { name: '水泳' },
                    { name: 'バスケ' }, { name: 'テニス' }, { name: 'ダンス' },
                    { name: '卓球' }, { name: 'バレー' },
                ]
            },
            color: {
                label: '好きな色',
                unit: '人',
                items: [
                    { name: '赤' }, { name: '青' }, { name: '黄' }, { name: '緑' },
                    { name: '黒' }, { name: '白' }, { name: 'ピンク' }, { name: '紫' },
                ]
            },
            animal: {
                label: '好きな動物',
                unit: '人',
                items: [
                    { name: '犬' }, { name: '猫' }, { name: 'うさぎ' }, { name: 'ハムスター' },
                    { name: 'パンダ' }, { name: 'ペンギン' }, { name: 'コアラ' }, { name: 'ライオン' },
                ]
            }
        };

        // 問題タイプ
        const QUESTION_TYPES = {
            read: { id: 'read', label: '表やグラフを読む' },
            max: { id: 'max', label: '一番多い' },
            min: { id: 'min', label: '一番少ない' },
            sum_two: { id: 'sum_two', label: '2つを合わせる' },
            diff: { id: 'diff', label: 'ちがいを答える' },
            cond_more: { id: 'cond_more', label: '〇〇以上' },
            cond_less: { id: 'cond_less', label: '〇〇以下' },
        };

        const MAX_SCALE = 15;

        // --- アプリケーションの状態 ---
        let state = {
            mode: 'settings', // 'settings' | 'print'
            config: {
                theme: 'sports',
                itemCount: 5,
                questionCount: 4, 
                selectedTypes: ['read', 'max', 'min', 'sum_two', 'diff', 'cond_more', 'cond_less'],
                showTable: false, // デフォルトOFFに変更
            },
            drillData: {
                items: [],
                questions: [],
                unit: '',
                id: 1,
            },
            showAns: false
        };

        // --- ロジック関数 ---

        function generateDrill() {
            const themeData = THEMES[state.config.theme];
            const unit = themeData.unit;

            // 1. アイテムのランダム選択と数値生成
            const shuffledItems = [...themeData.items].sort(() => 0.5 - Math.random());
            const selectedItems = shuffledItems.slice(0, state.config.itemCount).map(item => ({
                ...item,
                value: Math.floor(Math.random() * (MAX_SCALE - 5)) + 3 // 3〜12
            }));

            // ソート済みデータ
            const sortedData = [...selectedItems].sort((a, b) => b.value - a.value);
            const maxItem = sortedData[0];
            const minItem = sortedData[sortedData.length - 1];

            // 2. 問題の生成
            let typePool = [];
            const availableTypes = state.config.selectedTypes;

            if (availableTypes.length > 0) {
                typePool = [...availableTypes];
            } else {
                typePool = ['read'];
            }

            typePool.sort(() => 0.5 - Math.random());

            if (availableTypes.includes('read')) {
                typePool = typePool.filter(t => t !== 'read');
                typePool.unshift('read');
            }

            let finalQuestionTypes = [];
            let poolIndex = 0;
            
            while (finalQuestionTypes.length < state.config.questionCount) {
                if (typePool.length === 0) break;
                finalQuestionTypes.push(typePool[poolIndex]);
                poolIndex = (poolIndex + 1) % typePool.length;
                if (poolIndex === 0) typePool.sort(() => 0.5 - Math.random());
            }

            let generatedQuestions = [];
            for (let type of finalQuestionTypes) {
                let q = {};
                const target = selectedItems[Math.floor(Math.random() * selectedItems.length)];
                
                switch (type) {
                    case 'read':
                        q = {
                            text: `「${target.name}」は、何${unit} ですか。`,
                            answer: `${target.value}${unit}`
                        };
                        break;
                    case 'max':
                        q = { text: '一番 多いのは どれですか。', answer: maxItem.name };
                        break;
                    case 'min':
                        q = { text: '一番 少ないのは どれですか。', answer: minItem.name };
                        break;
                    case 'sum_two':
                        const idxA = Math.floor(Math.random() * selectedItems.length);
                        let idxB = Math.floor(Math.random() * selectedItems.length);
                        while(idxA === idxB) idxB = Math.floor(Math.random() * selectedItems.length);
                        const itemSumA = selectedItems[idxA];
                        const itemSumB = selectedItems[idxB];
                        q = {
                            text: `「${itemSumA.name}」と「${itemSumB.name}」を 合わせると 何${unit}になりますか。`,
                            answer: `${itemSumA.value + itemSumB.value}${unit}`
                        };
                        break;
                    case 'diff':
                        const idx1 = Math.floor(Math.random() * selectedItems.length);
                        let idx2 = Math.floor(Math.random() * selectedItems.length);
                        while(idx1 === idx2) idx2 = Math.floor(Math.random() * selectedItems.length);
                        const itemA = selectedItems[idx1];
                        const itemB = selectedItems[idx2];
                        if (itemA.value >= itemB.value) {
                            q = {
                                text: `「${itemA.name}」は、「${itemB.name}」より 何${unit} 多いですか。`,
                                answer: `${itemA.value - itemB.value}${unit}`
                            };
                        } else {
                            q = {
                                text: `「${itemB.name}」は、「${itemA.name}」より 何${unit} 多いですか。`,
                                answer: `${itemB.value - itemA.value}${unit}`
                            };
                        }
                        break;
                    case 'cond_more':
                        const minVal = minItem.value;
                        const maxVal = maxItem.value;
                        const range = Math.max(1, maxVal - minVal);
                        const thresholdMore = minVal + Math.floor(Math.random() * range);
                        q = {
                            text: `${thresholdMore}${unit}以上の ものは、いくつ ありますか。`,
                            answer: `${selectedItems.filter(item => item.value >= thresholdMore).length}つ`
                        };
                        break;
                    case 'cond_less':
                        const minValL = minItem.value;
                        const maxValL = maxItem.value;
                        const rangeL = Math.max(1, maxValL - minValL);
                        const thresholdLess = minValL + Math.floor(Math.random() * rangeL) + 1;
                        q = {
                            text: `${thresholdLess}${unit}以下の ものは、いくつ ありますか。`,
                            answer: `${selectedItems.filter(item => item.value <= thresholdLess).length}つ`
                        };
                        break;
                }
                generatedQuestions.push(q);
            }

            state.drillData = {
                items: selectedItems,
                questions: generatedQuestions,
                unit: unit,
                id: Math.floor(Math.random() * 10000)
            };
            state.mode = 'print';
            state.showAns = false;
            render();
        }

        // --- イベントハンドラ ---

        function handleConfigChange(key, value) {
            state.config[key] = value;
            render();
        }

        // カウンターの増減
        function updateCount(key, delta, min, max) {
            const current = state.config[key];
            const next = current + delta;
            if (next >= min && next <= max) {
                handleConfigChange(key, next);
            }
        }

        function toggleQuestionType(typeId) {
            const current = state.config.selectedTypes;
            const next = current.includes(typeId)
                ? current.filter(t => t !== typeId)
                : [...current, typeId];
            state.config.selectedTypes = next.length === 0 ? [typeId] : next;
            render();
        }

        // 問題文の編集
        function updateQuestionText(index, newText) {
            state.drillData.questions[index].text = newText;
            // 再描画はせず、DOM要素の値はinputなのでそのまま保持されるが
            // データ整合性のためにstateは更新しておく
        }

        function setMode(newMode) {
            state.mode = newMode;
            render();
        }

        function toggleAnswers() {
            state.showAns = !state.showAns;
            render();
        }

        // --- 描画関数 ---

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = ''; // クリア

            if (state.mode === 'settings') {
                renderSettings(app);
            } else {
                renderPrint(app);
            }
        }

        function renderSettings(container) {
            // テーマボタンHTML生成
            const themeButtons = Object.entries(THEMES).map(([key, theme]) => {
                const isActive = state.config.theme === key;
                const activeClass = isActive ? 'border-gray-800 bg-gray-100 ring-1 ring-gray-400 font-bold' : 'border-gray-300 hover:bg-gray-50';
                return `<button onclick="handleConfigChange('theme', '${key}')" class="p-3 rounded border text-left transition-all ${activeClass}">${theme.label}</button>`;
            }).join('');

            // 出題パターンHTML生成
            const typeCheckboxes = Object.values(QUESTION_TYPES).map(type => {
                const isChecked = state.config.selectedTypes.includes(type.id);
                const bgClass = isChecked ? 'bg-gray-700 border-gray-700 text-white' : 'bg-white border-gray-400';
                const icon = isChecked ? Icons.checkSquare : '';
                return `
                    <label class="flex items-center gap-3 p-2 rounded hover:bg-gray-100 cursor-pointer border border-transparent hover:border-gray-200">
                        <div onclick="toggleQuestionType('${type.id}')" class="w-5 h-5 rounded border flex items-center justify-center transition-colors ${bgClass}">
                            ${icon}
                        </div>
                        <span class="text-gray-800 text-sm">${type.label}</span>
                    </label>
                `;
            }).join('');

            const html = `
                <div class="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-lg mt-8 border border-gray-200 font-sans">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2 border-b pb-2">
                        <span class="text-gray-600">${Icons.settings}</span>
                        ドリル設定
                    </h2>

                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">テーマ</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            ${themeButtons}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- グラフの項目数 (カウンターUIに変更) -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">グラフの項目数</label>
                            <div class="flex items-center gap-3">
                                <button onclick="updateCount('itemCount', -1, 3, 6)" class="w-10 h-10 flex items-center justify-center border border-gray-300 rounded hover:bg-gray-100 text-gray-600 ${state.config.itemCount <= 3 ? 'opacity-50 cursor-not-allowed' : ''}">
                                    ${Icons.minus}
                                </button>
                                <div class="text-xl font-bold w-12 text-center">${state.config.itemCount}</div>
                                <button onclick="updateCount('itemCount', 1, 3, 6)" class="w-10 h-10 flex items-center justify-center border border-gray-300 rounded hover:bg-gray-100 text-gray-600 ${state.config.itemCount >= 6 ? 'opacity-50 cursor-not-allowed' : ''}">
                                    ${Icons.plus}
                                </button>
                            </div>
                        </div>

                        <!-- 問題数 (カウンターUIに変更) -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">問題数</label>
                            <div class="flex items-center gap-3">
                                <button onclick="updateCount('questionCount', -1, 1, 6)" class="w-10 h-10 flex items-center justify-center border border-gray-300 rounded hover:bg-gray-100 text-gray-600 ${state.config.questionCount <= 1 ? 'opacity-50 cursor-not-allowed' : ''}">
                                    ${Icons.minus}
                                </button>
                                <div class="text-xl font-bold w-12 text-center">${state.config.questionCount}</div>
                                <button onclick="updateCount('questionCount', 1, 1, 6)" class="w-10 h-10 flex items-center justify-center border border-gray-300 rounded hover:bg-gray-100 text-gray-600 ${state.config.questionCount >= 6 ? 'opacity-50 cursor-not-allowed' : ''}">
                                    ${Icons.plus}
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6 bg-gray-50 p-4 rounded border border-gray-200">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" ${state.config.showTable ? 'checked' : ''} 
                                onchange="handleConfigChange('showTable', this.checked)"
                                class="w-5 h-5 text-gray-600 rounded focus:ring-gray-500 border-gray-300">
                            <span class="font-bold text-gray-700">表（テーブル）を表示する</span>
                        </label>
                    </div>

                    <div class="mb-8">
                        <label class="block text-sm font-bold text-gray-700 mb-2">出題パターン</label>
                        <p class="text-xs text-gray-500 mb-2">※選んだ中からランダムに出題されます</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            ${typeCheckboxes}
                        </div>
                    </div>

                    <button onclick="generateDrill()" class="w-full py-4 bg-gray-800 text-white rounded-lg font-bold text-lg hover:bg-gray-700 shadow-md transition flex items-center justify-center gap-2">
                        ${Icons.fileText}
                        ドリルを作成
                    </button>
                </div>
            `;
            container.innerHTML = html;
        }

        function renderPrint(container) {
            const { items, questions, unit, id } = state.drillData;
            
            // 表のHTML
            let tableHtml = '';
            if (state.config.showTable) {
                const rows = items.map(item => `
                    <tr>
                        <td class="border border-gray-800 p-2">${item.name}</td>
                        <td class="border border-gray-800 p-2">${item.value}</td>
                    </tr>
                `).join('');
                const total = items.reduce((a, b) => a + b.value, 0);
                
                tableHtml = `
                    <div class="w-full md:w-1/3 print-w-1-3">
                        <table class="w-full border-collapse border border-gray-800 text-center text-lg">
                            <thead class="bg-gray-100 print-bg-gray-100">
                                <tr>
                                    <th class="border border-gray-800 p-2 w-1/2">項目</th>
                                    <th class="border border-gray-800 p-2 w-1/2">かず</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                                <tr class="border-t-2 border-gray-800">
                                    <td class="border border-gray-800 p-2 bg-gray-50 print-bg-gray-50 font-bold">合計</td>
                                    <td class="border border-gray-800 p-2 font-bold">${total}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // グラフのHTML
            const gridLines = Array.from({length: MAX_SCALE + 1}, (_, i) => {
                const isMain = i % 5 === 0;
                const label = isMain ? `<span class="absolute -left-6 -translate-y-1/2 text-sm text-gray-700">${i === 0 ? 0 : i}</span>` : '';
                const unitLabel = (i === MAX_SCALE) ? `<span class="absolute -left-2 -top-8 text-sm font-bold">(${unit})</span>` : '';
                const borderColor = isMain ? 'border-gray-800' : 'border-gray-400';
                const tick = `<div class="w-2 absolute -left-2 top-0 border-t ${borderColor}"></div>`;
                
                return `
                    <div class="absolute w-full border-t border-gray-300" style="bottom: ${(i / MAX_SCALE) * 100}%; left: 0; right: 0;">
                        ${label}
                        ${tick}
                        ${unitLabel}
                    </div>
                `;
            }).join('');

            const bars = items.map(item => `
                <div class="relative w-12 h-full flex flex-col justify-end">
                    <div class="w-full border border-gray-800 transition-all bg-gray-200 print-bg-gray-200 print-border-gray-800" style="height: ${(item.value / MAX_SCALE) * 100}%"></div>
                    <div class="absolute -bottom-10 w-24 left-1/2 -translate-x-1/2 text-center text-sm font-bold leading-tight mt-1">
                        ${item.name}
                    </div>
                </div>
            `).join('');

            const graphHtml = `
                <div class="pl-2 ${state.config.showTable ? 'w-full md:w-2/3 print-w-2-3' : 'w-full mx-auto max-w-2xl'}">
                    <div class="relative border-l border-b border-gray-800 h-64 w-full mt-4 box-border mb-8 pb-4">
                        ${gridLines}
                        <div class="absolute inset-0 flex justify-around px-4 items-end">
                            ${bars}
                        </div>
                    </div>
                </div>
            `;

            // 問題のHTML（編集可能なInputに変更）
            const questionsHtml = questions.map((q, idx) => `
                <div class="flex flex-col mb-4">
                    <div class="text-base mb-1 flex items-start leading-relaxed w-full">
                        <span class="font-bold mr-2 whitespace-nowrap pt-1">問${idx + 1}.</span>
                        <div class="relative flex-grow">
                            <input 
                                type="text" 
                                value="${q.text}" 
                                oninput="updateQuestionText(${idx}, this.value)"
                                class="question-input w-full p-1 border-b border-transparent hover:border-gray-300 focus:border-gray-800 focus:bg-white focus:outline-none transition bg-transparent"
                            >
                            <div class="absolute right-0 top-1 text-gray-400 pointer-events-none no-print">
                                ${Icons.edit}
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end pr-4">
                        <div class="flex items-end gap-2 w-full max-w-xs">
                            <div class="border-b-2 border-gray-800 w-full h-10 relative flex items-center justify-center bg-gray-50">
                                ${state.showAns ? `<span class="text-lg text-gray-900 font-bold">${q.answer}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            const html = `
                <div class="min-h-screen bg-white">
                    <!-- コントロールバー -->
                    <div class="sticky top-0 z-50 bg-gray-800 text-white p-4 shadow-md no-print mb-8">
                        <div class="max-w-4xl mx-auto flex justify-between items-center flex-wrap gap-2">
                            <button onclick="setMode('settings')" class="flex items-center gap-2 text-gray-300 hover:text-white transition text-sm md:text-base font-sans">
                                ${Icons.arrowLeft} 設定
                            </button>
                            <div class="flex gap-3 font-sans">
                                <button onclick="generateDrill()" class="flex items-center gap-2 px-3 py-2 bg-gray-600 rounded hover:bg-gray-500 transition text-sm">
                                    ${Icons.refresh} 更新
                                </button>
                                <button onclick="toggleAnswers()" class="flex items-center gap-2 px-3 py-2 bg-gray-600 rounded hover:bg-gray-500 transition text-sm">
                                    ${state.showAns ? Icons.eyeOff : Icons.eye}
                                    ${state.showAns ? '隠す' : '答え'}
                                </button>
                                <button onclick="window.print()" class="flex items-center gap-2 px-4 py-2 bg-white text-gray-900 rounded hover:bg-gray-100 transition font-bold text-sm">
                                    ${Icons.printer} 印刷
                                </button>
                            </div>
                        </div>
                        <div class="max-w-4xl mx-auto mt-2 text-xs text-gray-400">
                             ※問題文をクリックするとテキストを自由に編集できます
                        </div>
                    </div>

                    <!-- 印刷用紙エリア -->
                    <div class="max-w-[210mm] mx-auto bg-white shadow-xl print-shadow-none print-w-full p-10 min-h-[297mm] text-black">
                        
                        <!-- ヘッダー -->
                        <div class="flex justify-between items-end mb-4 pb-2">
                            <h1 class="text-lg font-bold tracking-wider">${THEMES[state.config.theme].label}</h1>
                            <div class="border-b border-gray-400 w-48 pb-1 px-2 text-gray-500 text-sm flex items-end justify-between">
                                <span>なまえ</span>
                                <span class="text-black text-lg"></span>
                            </div>
                        </div>

                        <!-- 表とグラフ -->
                        <div class="flex gap-6 mb-6 print-flex-row ${state.config.showTable ? 'flex-col md:flex-row' : 'flex-col'}">
                            ${tableHtml}
                            ${graphHtml}
                        </div>

                        <!-- 問題エリア -->
                        <div class="mt-6 pt-2">
                            <div class="space-y-4">
                                ${questionsHtml}
                            </div>
                        </div>
                        
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        // --- 初期化 ---
        render();

    </script>
</body>
</html>
